FROM continuumio/miniconda3
ARG NB_USER="user1000"
ARG NB_UID="1000"
ARG NB_GID="100"
ARG CONDA_ENV="client_env"

ENV CONDA_DIR=/opt/conda \
    HOME=/home/$NB_USER

RUN echo 'eval "$(command conda shell.bash hook 2> /dev/null)"' >> /etc/skel/.bashrc

RUN useradd -m -s /bin/bash -N -u $NB_UID $NB_USER &&\
    mkdir -p $CONDA_DIR && \
    chown $NB_USER:$NB_GID $CONDA_DIR

USER $NB_USER
COPY --chown=$NB_UID:$NB_GID ../environment.yml ./data/split ./requirements.txt ./setup.py /home/$NB_USER/rtn_pipeline/
COPY ../rtn /home/$NB_USER/rtn_pipeline/rtn/

WORKDIR /home/$NB_USER/rtn_pipeline

RUN conda env create -f /home/$NB_USER/rtn_pipeline/environment.yml
ENV PATH /opt/conda/envs/client_env/bin:$PATH:/home/$NB_USER/.local/bin